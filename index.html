<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="theme-color" content="#0a0a14">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <title>Neon Core HARD MODE</title>
    <style>
        :root {
            /* --- NEON CYBER PALET --- */
            --bg-dark: #050505;
            --bg-grad: linear-gradient(135deg, #050505, #120012, #001212); 
            --neon-blue: #00f3ff; --neon-green: #0aff00; --neon-pink: #ff00ff; --neon-gold: #ffd700;
            --glass-bg: rgba(255, 255, 255, 0.03); --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --radius: 24px; --text: #ffffff; --text-mute: #8b9bb4;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-grad); background-attachment: fixed; 
            color: var(--text); margin: 0; padding: 0; min-height: 100vh;
            overflow-x: hidden; user-select: none;
        }
        .screen { display: none; flex-direction: column; min-height: 100vh; padding: 20px; padding-bottom: 140px; box-sizing: border-box; }
        .screen.active { display: flex; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { font-size: 1.5rem; margin: 0; font-weight: 800; letter-spacing: 1px; text-shadow: 2px 2px 0px var(--neon-pink), -1px -1px 10px var(--neon-blue); }
        
        /* LEVEL UI */
        .level-container { margin-bottom: 25px; text-align: center; }
        .rank-symbol { font-size: 3.5rem; margin-bottom: 5px; display: inline-block; filter: drop-shadow(0 0 10px var(--neon-gold)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .level-title { font-size: 1.2rem; font-weight: bold; color: var(--neon-gold); letter-spacing: 2px; }
        .xp-track { width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; position: relative; }
        .xp-fill { height: 100%; background: var(--neon-blue); width: 0%; box-shadow: 0 0 10px var(--neon-blue); transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(10px); border: var(--glass-border); border-radius: var(--radius); padding: 25px; margin-bottom: 25px; position: relative; overflow: hidden; }
        .panel-blue::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
        .panel-pink::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }

        .btn-icon { background: rgba(255,255,255,0.05); border: var(--glass-border); color: var(--text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; }
        .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .week-title { font-weight: 800; font-size: 1.4rem; text-align: center; }
        .tracker-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .check-circle { width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .check-circle.completed { background: var(--neon-green); border: none; color: #000; box-shadow: 0 0 15px var(--neon-green); }

        .preview-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .preview-item span:last-child { color: var(--neon-blue); font-weight: 800; }

        /* PLAYER */
        #playerScreen { background: rgba(5, 5, 10, 0.98); text-align: center; justify-content: center; align-items: center; padding-bottom: 20px; z-index: 50; }
        .player-xp-container { position: absolute; top: 0; left: 0; width: 100%; padding: 15px 20px; box-sizing: border-box; background: rgba(0,0,0,0.6); border-bottom: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .xp-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .xp-level-group { display: flex; align-items: center; gap: 10px; }
        .game-symbol { font-size: 2rem; filter: drop-shadow(0 0 5px var(--neon-gold)); animation: pulseSymbol 2s infinite; }
        @keyframes pulseSymbol { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .session-timer { position: absolute; top: 90px; width: 100%; text-align: center; font-family: monospace; font-size: 1.5rem; font-weight: bold; color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); }
        .timer-circle { width: 220px; height: 220px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; margin: 120px auto 30px auto; font-size: 4.5rem; font-weight: 900; font-variant-numeric: tabular-nums; transition: all 0.5s ease; }
        
        .xp-float { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: 900; color: var(--neon-blue); text-shadow: 0 0 20px var(--neon-blue); opacity: 0; pointer-events: none; z-index: 60; }
        .xp-float.animate { animation: xpUp 1s ease-out forwards; }
        @keyframes xpUp { 0% { opacity: 0; transform: translate(-50%, 0); } 20% { opacity: 1; transform: translate(-50%, -30px); } 100% { opacity: 0; transform: translate(-50%, -80px); } }

        .state-rest .timer-circle { box-shadow: 0 0 50px var(--neon-pink), inset 0 0 20px var(--neon-pink); color: var(--neon-pink); border-color: var(--neon-pink); }
        .state-work .timer-circle { box-shadow: 0 0 60px var(--neon-blue), inset 0 0 30px var(--neon-blue); color: var(--neon-blue); border-color: var(--neon-blue); }
        .state-manual .timer-circle { box-shadow: 0 0 50px var(--neon-green), inset 0 0 20px var(--neon-green); color: var(--neon-green); border-style: dashed; border-color: var(--neon-green); }

        .bottom-action-bar { position: fixed; bottom: 0; left: 0; width: 100%; padding: 25px; background: linear-gradient(to top, #000 80%, transparent); text-align: center; z-index: 100; box-sizing: border-box; }
        .big-btn { background: var(--neon-blue); color: #000; border: none; width: 100%; max-width: 500px; padding: 20px; font-size: 1.3rem; font-weight: 900; border-radius: 50px; cursor: pointer; box-shadow: 0 0 30px var(--neon-blue); text-transform: uppercase; letter-spacing: 2px; }
        .big-btn:active { transform: scale(0.98); }
        .action-btn { background: var(--neon-green); box-shadow: 0 0 30px var(--neon-green); color: #000; }
        .stop-link { color: var(--neon-pink); text-decoration: underline; background: none; border: none; margin-top: 15px; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; }

        /* MODAL */
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 999; display: none; align-items: center; justify-content: center; }
        #modalOverlay.show { display: flex; }
        .modal-content { background: #0f0518; border: 2px solid var(--neon-pink); padding: 40px; border-radius: 30px; text-align: center; max-width: 85%; box-shadow: 0 0 60px var(--neon-pink); }
        .close-modal-btn { background: transparent; border: 2px solid var(--neon-pink); color: var(--neon-pink); margin-top: 20px; padding: 15px 30px; border-radius: 30px; font-weight:bold; cursor: pointer; box-shadow: 0 0 15px var(--neon-pink); text-transform: uppercase; }

        /* STATS */
        #statsScreen { background: #050505; z-index: 100; }
        .grand-total-box { background: rgba(255,255,255,0.05); border: 1px solid var(--neon-pink); padding: 20px; border-radius: var(--radius); margin-bottom: 20px; box-shadow: 0 0 30px rgba(255, 0, 255, 0.2); color: #fff; }
        .stats-detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="dashboardScreen" class="screen active">
        <header>
            <h1>NEON CORE</h1>
            <button class="btn-icon" onclick="showStats()">üìä</button>
        </header>

        <div class="level-container">
            <div class="rank-symbol" id="dashSymbol">üå±</div>
            <div class="level-title" id="dashLevelTitle">LEVEL 1</div>
            <div class="level-sub" id="dashNextLevel">Hard Mode Activated</div>
            <div style="width: 80%; margin: 0 auto;">
                <div class="xp-track"><div class="xp-fill" id="dashXpBar"></div></div>
            </div>
        </div>

        <div class="glass-panel panel-pink">
            <div class="week-nav">
                <button class="btn-icon" onclick="changeWeek(-1)">‚Üê</button>
                <div>
                    <div class="week-title" id="weekDisplay">Week 1</div>
                    <div style="font-size:0.8rem; color:var(--text-mute); margin-top:5px; text-align:center;">HARD MODE</div>
                </div>
                <button class="btn-icon" onclick="changeWeek(1)">‚Üí</button>
            </div>
            <div class="tracker-container" id="weekTracker"></div>
            <div style="text-align: center; margin-top: 10px; color: var(--text-mute); font-size: 0.8rem;">DOEL: 3 SESSIES / WEEK</div>
        </div>

        <div class="glass-panel panel-blue">
            <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; color:var(--neon-blue);">CIRCUIT VANDAAG</h3>
            <div id="previewList"></div>
        </div>

        <div class="bottom-action-bar">
            <button class="big-btn" onclick="startWorkout()">START TRAINING ‚ñ∂</button>
        </div>
    </div>

    <div id="playerScreen" class="screen">
        <div class="player-xp-container">
            <div class="xp-header">
                <div class="xp-level-group">
                    <span class="game-symbol" id="gameSymbol">üå±</span>
                    <span class="xp-text" id="gameLevel">LVL 1</span>
                </div>
                <span class="xp-text" style="font-size:0.7rem; opacity:0.7;">XP</span>
            </div>
            <div class="xp-track"><div class="xp-fill" id="gameXpBar"></div></div>
        </div>

        <div class="session-timer" id="sessionTimerDisplay">00:00</div>
        <div class="xp-float" id="xpFloat">+XP</div>

        <div style="width: 100%;">
            <div class="timer-circle" id="timerDisplay">6</div>
            <div style="text-align:center; font-size:1.8rem; font-weight:800; margin-bottom:5px;" id="exName">Klaarmaken...</div>
            <div style="text-align:center; font-size:1.2rem; color:var(--text-mute);" id="exDetail">Start in</div>
            <div id="roundDisplay" style="text-align:center; color:var(--text-mute); margin-top:15px; font-weight:bold;">Ronde 1 / 3</div>
        </div>

        <div style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 30px;">
            <button id="actionBtn" class="big-btn action-btn" onclick="handleAction()" style="display:none; width:80%;">VOLGENDE</button>
            <button class="stop-link" onclick="quitWorkout()">Afbreken</button>
        </div>
    </div>

    <div id="statsScreen" class="screen">
        <header>
            <h1>STATISTIEKEN</h1>
            <button class="btn-icon" onclick="closeStats()">‚úï</button>
        </header>
        <div style="overflow-y: auto; padding-bottom: 20px;" id="statsContent"></div>
    </div>

    <div id="modalOverlay">
        <div class="modal-content">
            <div style="font-size: 4rem; margin-bottom: 10px;" id="modalIcon">üèÜ</div>
            <h2 style="font-size: 2rem; margin: 0; color: #fff; text-shadow: 0 0 10px var(--neon-green);" id="modalTitle">TRAINING COMPLEET!</h2>
            <p style="color: var(--text-mute); font-size: 1.2rem; margin-top:10px;" id="modalText">XP opgeslagen.</p>
            <button class="close-modal-btn" onclick="closeModal()">SLUITEN</button>
        </div>
    </div>

<script>
    const RANK_SYMBOLS = ["üå±","ü¶†","üß¨","ü•ö","ü™µ","ü™®","üß±","üîß","ü™õ","üî®","üêû","ü™±","ü¶ü","ü™≥","üï∑Ô∏è","ü¶ó","ü¶ã","üêõ","üêå","ü¶Ç","üê≠","üêπ","üê∞","üêøÔ∏è","ü¶î","ü¶é","üê¢","üêç","üê∏","ü¶Ä","üêì","ü¶É","ü¶Ü","ü¶¢","ü¶ú","ü¶©","ü¶ö","ü¶â","ü¶Ö","ü¶á","üêà","üêï","ü¶ä","ü¶ù","ü¶°","ü¶¶","ü¶®","ü¶ò","üêí","ü¶ç","zebra","üêé","üêÇ","üêÉ","üêÑ","üêñ","üêè","üêë","üêê","ü¶å","üêÜ","üêÖ","ü¶Å","üê∫","üêª","üêª‚Äç‚ùÑÔ∏è","üêº","üê®","üêò","ü¶è","üå™Ô∏è","üî•","üåä","‚ö°","‚ùÑÔ∏è","‚òÑÔ∏è","üåë","üåï","‚òÄÔ∏è","‚≠ê","ü§∫","üèá","üèãÔ∏è","ü§∏","ü•∑","ü¶∏","üßû","üßú","üßõ","üßü","üêâ","üê≤","ü¶ñ","ü¶ï","ü¶à","üêã","üêô","ü¶ë","üêä","ü¶ï","üëë"];

    const TOTAL_EXERCISES_IN_PROGRAM = 8 * 3 * 3 * 10; 
    const TOTAL_ROUNDS = 3;
    const PREP_TIME = 6;    // 6 sec rust tussen oefeningen
    const ROUND_REST = 90;  // 90 sec rust na ronde

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(freq = 440, duration = 0.1, type = 'sine') {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    let wakeLock = null;
    async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
    async function releaseWakeLock() { if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; } }

    // DATA: 10 OEFENINGEN
    const exercises = [
        { id: 'plank', name: 'De Plank', type: 'time', unit: 'sec' }, // 1
        { id: 'pushup', name: 'Push-ups', type: 'reps', unit: 'x' },  // 2
        { id: 'row_r', name: 'DB Row (Rechts)', type: 'reps', unit: 'x' }, // 3
        { id: 'row_l', name: 'DB Row (Links)', type: 'reps', unit: 'x' },  // 4
        { id: 'dips', name: 'Tricep Dips', type: 'reps', unit: 'x' },      // 5
        { id: 'squats', name: 'Goblet Squats', type: 'reps', unit: 'x' },  // 6 (NAAM AANGEPAST VOOR HALTER)
        { id: 'legraise', name: 'Lying Leg Raises', type: 'reps', unit: 'x' }, // 7
        { id: 'bicycle', name: 'Bicycle Crunches', type: 'reps', unit: 'x' },  // 8
        { id: 'twists', name: 'Russian Twists', type: 'reps', unit: 'x' },     // 9
        { id: 'leghold', name: 'Leg Hold (5cm)', type: 'time', unit: 'sec' }   // 10
    ];

    // HARD MODE PROGRESSION
    const weeklyProgression = {
        1: { plank: 60, pushup: 15, row_r:12, row_l:12, dips:12, squats:25, legraise: 15, bicycle: 30, twists: 30, leghold: 30 },
        2: { plank: 70, pushup: 18, row_r:14, row_l:14, dips:14, squats:30, legraise: 18, bicycle: 36, twists: 36, leghold: 35 },
        3: { plank: 80, pushup: 20, row_r:15, row_l:15, dips:15, squats:35, legraise: 20, bicycle: 40, twists: 40, leghold: 40 },
        4: { plank: 90, pushup: 22, row_r:16, row_l:16, dips:18, squats:40, legraise: 20, bicycle: 44, twists: 44, leghold: 45 },
        5: { plank: 100, pushup: 25, row_r:18, row_l:18, dips:20, squats:50, legraise: 25, bicycle: 50, twists: 50, leghold: 50 },
        6: { plank: 120, pushup: 28, row_r:20, row_l:20, dips:22, squats:60, legraise: 25, bicycle: 60, twists: 60, leghold: 60 },
        7: { plank: 150, pushup: 30, row_r:22, row_l:22, dips:25, squats:70, legraise: 30, bicycle: 70, twists: 70, leghold: 75 },
        8: { plank: 180, pushup: 35, row_r:25, row_l:25, dips:30, squats:80, legraise: 30, bicycle: 80, twists: 80, leghold: 90 }
    };

    let state = { currentWeek: 1, history: [], totalExercisesDone: 0, isActive: false, round: 1, exIndex: 0, phase: 'idle', timeLeft: 0, timerInterval: null, sessionStartTime: 0, sessionInterval: null, sessionDuration: 0 };

    window.onload = function() {
        // We gebruiken dezelfde key 'abs_pro_v4' om stats te behouden!
        let saved = localStorage.getItem('abs_pro_v4');
        if(saved) {
            const parsed = JSON.parse(saved);
            state.currentWeek = parsed.currentWeek || 1;
            state.history = parsed.history || [];
            state.totalExercisesDone = parsed.totalExercisesDone || 0;
        }
        updateLevelUI(); renderDashboard();
    };

    function saveData() { localStorage.setItem('abs_pro_v4', JSON.stringify({ currentWeek: state.currentWeek, history: state.history, totalExercisesDone: state.totalExercisesDone })); }

    function getLevelInfo() {
        let rawLevel = (state.totalExercisesDone / TOTAL_EXERCISES_IN_PROGRAM) * 100;
        let level = Math.floor(rawLevel) + 1; if(level > 100) level = 100;
        let progress = (rawLevel % 1) * 100; if(level === 100) progress = 100;
        let symbolIndex = level - 1; if(symbolIndex >= RANK_SYMBOLS.length) symbolIndex = RANK_SYMBOLS.length - 1;
        return { level, progress, symbol: RANK_SYMBOLS[symbolIndex] };
    }

    function updateLevelUI() {
        const info = getLevelInfo();
        document.getElementById('dashSymbol').innerText = info.symbol;
        document.getElementById('dashLevelTitle').innerText = `LEVEL ${info.level}`;
        document.getElementById('dashXpBar').style.width = `${info.progress}%`;
        document.getElementById('gameLevel').innerText = `LVL ${info.level}`;
        document.getElementById('gameSymbol').innerText = info.symbol; 
        document.getElementById('gameXpBar').style.width = `${info.progress}%`;
    }

    function renderDashboard() {
        document.getElementById('weekDisplay').innerText = `Week ${state.currentWeek}`;
        const targets = weeklyProgression[state.currentWeek];
        const list = document.getElementById('previewList');
        list.innerHTML = '';
        exercises.forEach(ex => { list.innerHTML += `<div class="preview-item"><span>${ex.name}</span><span>${targets[ex.id]} ${ex.unit}</span></div>`; });

        const workoutsThisWeek = state.history.filter(h => h.week === state.currentWeek).length;
        const tracker = document.getElementById('weekTracker');
        tracker.innerHTML = '';
        const dotsToShow = Math.max(3, workoutsThisWeek);
        for(let i=0; i < dotsToShow; i++) {
            const isDone = i < workoutsThisWeek;
            tracker.innerHTML += `<div class="check-circle ${isDone ? 'completed' : ''}">${isDone ? '‚úì' : ''}</div>`;
        }
    }

    function changeWeek(dir) {
        if((state.currentWeek === 1 && dir === -1) || (state.currentWeek === 8 && dir === 1)) return;
        state.currentWeek += dir; renderDashboard();
    }

    function startWorkout() {
        requestWakeLock(); if(audioCtx.state === 'suspended') audioCtx.resume();
        state.isActive = true; state.round = 1; state.exIndex = 0;
        updateLevelUI(); 
        state.sessionStartTime = Date.now(); state.sessionDuration = 0;
        if(state.sessionInterval) clearInterval(state.sessionInterval);
        state.sessionInterval = setInterval(updateSessionTimer, 1000);
        document.getElementById('dashboardScreen').classList.remove('active');
        document.getElementById('playerScreen').classList.add('active');
        startPrep();
    }

    function updateSessionTimer() {
        const diff = Math.floor((Date.now() - state.sessionStartTime) / 1000);
        state.sessionDuration = diff;
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        document.getElementById('sessionTimerDisplay').innerText = `${m}:${s}`;
    }

    function startPrep() {
        if(state.timerInterval) clearInterval(state.timerInterval);
        state.phase = 'prep'; state.timeLeft = PREP_TIME;
        const currentEx = exercises[state.exIndex];
        document.getElementById('playerScreen').className = 'screen active state-rest';
        document.getElementById('roundDisplay').innerText = `Ronde ${state.round} / ${TOTAL_ROUNDS}`;
        document.getElementById('exName').innerText = "RUST / WISSEL";
        document.getElementById('exDetail').innerText = "Volgende: " + currentEx.name;
        document.getElementById('actionBtn').style.display = 'none';
        updateTimerDisplay();
        state.timerInterval = setInterval(() => {
            state.timeLeft--; updateTimerDisplay();
            if(state.timeLeft > 0 && state.timeLeft <= 3) playBeep(600, 0.05);
            if(state.timeLeft <= 0) startExercise();
        }, 1000);
    }

    function startExercise() {
        if(state.timerInterval) clearInterval(state.timerInterval);
        const currentEx = exercises[state.exIndex];
        const targetVal = weeklyProgression[state.currentWeek][currentEx.id];
        document.getElementById('exName').innerText = currentEx.name;
        
        if (currentEx.type === 'time') {
            state.phase = 'work'; state.timeLeft = targetVal;
            document.getElementById('playerScreen').className = 'screen active state-work';
            document.getElementById('exDetail').innerText = "HOU VOL!";
            document.getElementById('actionBtn').style.display = 'none';
            updateTimerDisplay();
            state.timerInterval = setInterval(() => {
                state.timeLeft--; updateTimerDisplay();
                if(state.timeLeft > 0 && state.timeLeft <= 5) playBeep(880, 0.1);
                if(state.timeLeft <= 0) { playBeep(1200, 0.3); completeStep(); }
            }, 1000);
        } else {
            state.phase = 'manual';
            document.getElementById('playerScreen').className = 'screen active state-manual';
            document.getElementById('exDetail').innerText = `Doe ${targetVal} herhalingen`;
            document.getElementById('timerDisplay').innerText = targetVal;
            document.getElementById('actionBtn').style.display = 'block';
        }
    }

    function handleAction() { if(state.phase === 'manual') completeStep(); }

    function completeStep() {
        state.totalExercisesDone++; saveData(); updateLevelUI(); 
        const floatEl = document.getElementById('xpFloat');
        floatEl.classList.remove('animate'); void floatEl.offsetWidth; floatEl.classList.add('animate');
        nextStep();
    }

    function nextStep() {
        if(state.timerInterval) clearInterval(state.timerInterval);
        if (state.exIndex < exercises.length - 1) {
            state.exIndex++; startPrep();
        } else {
            if (state.round < TOTAL_ROUNDS) {
                state.round++; state.exIndex = 0; startRoundRest();
            } else {
                finishWorkout(true);
            }
        }
    }

    function startRoundRest() {
        state.timeLeft = ROUND_REST; state.phase = 'prep'; 
        document.getElementById('playerScreen').className = 'screen active state-rest';
        document.getElementById('exName').innerText = "GROTE PAUZE";
        document.getElementById('exDetail').innerText = "Even op adem komen...";
        document.getElementById('actionBtn').style.display = 'none';
        state.timerInterval = setInterval(() => {
            state.timeLeft--; updateTimerDisplay();
            if(state.timeLeft > 0 && state.timeLeft <= 5) playBeep(600, 0.05);
            if(state.timeLeft <= 0) startExercise();
        }, 1000);
    }

    function updateTimerDisplay() { document.getElementById('timerDisplay').innerText = state.timeLeft; }

    function quitWorkout() {
        if(state.sessionInterval) clearInterval(state.sessionInterval);
        openModal("TRAINING GESTOPT", "XP is opgeslagen. Sessie telt niet voor weekdoel.", false);
    }

    function finishWorkout(success) {
        if(state.timerInterval) clearInterval(state.timerInterval);
        if(state.sessionInterval) clearInterval(state.sessionInterval);
        releaseWakeLock();
        if(success) {
            state.history.push({ date: new Date().toISOString(), week: state.currentWeek, duration: state.sessionDuration });
            saveData(); openModal("TRAINING COMPLEET!", "XP & Sessie Opgeslagen!", true);
        }
    }

    function openModal(title, text, isSuccess) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalTitle').style.textShadow = isSuccess ? '0 0 10px var(--neon-green)' : '0 0 10px var(--neon-pink)';
        document.getElementById('modalIcon').innerText = isSuccess ? 'üèÜ' : 'üíæ';
        document.getElementById('modalText').innerText = text;
        document.getElementById('modalOverlay').classList.add('show');
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('show');
        document.getElementById('playerScreen').classList.remove('active');
        document.getElementById('dashboardScreen').classList.add('active');
        renderDashboard();
    }

    function showStats() { document.getElementById('dashboardScreen').classList.remove('active'); document.getElementById('statsScreen').classList.add('active'); calculateStats(); }
    function closeStats() { document.getElementById('statsScreen').classList.remove('active'); document.getElementById('dashboardScreen').classList.add('active'); }

    function calculateStats() {
        const container = document.getElementById('statsContent'); container.innerHTML = '';
        let grandTotal = {}; exercises.forEach(ex => grandTotal[ex.id] = 0);
        let totalSecondsTrained = 0;

        for(let w=1; w<=8; w++) {
            const workouts = state.history.filter(h => h.week === w);
            const count = workouts.length;
            if(count === 0) continue;
            workouts.forEach(w => { if(w.duration) totalSecondsTrained += w.duration; });
            const targets = weeklyProgression[w];
            let weekHtml = `<div class="glass-panel panel-blue"><h3 style="margin:0; color:#fff;">Week ${w} <span style="font-size:0.8rem; color:var(--text-mute)">(${count} trainingen)</span></h3><div style="margin-top:10px;">`;
            exercises.forEach(ex => {
                const totalForEx = targets[ex.id] * 3 * count; 
                grandTotal[ex.id] += totalForEx;
                weekHtml += `<div class="stats-detail-row"><span>${ex.name}</span><span>${totalForEx} ${ex.unit}</span></div>`;
            });
            weekHtml += `</div></div>`;
            container.innerHTML += weekHtml; 
        }

        let hours = Math.floor(totalSecondsTrained / 3600); let mins = Math.floor((totalSecondsTrained % 3600) / 60);
        let timeString = hours > 0 ? `${hours}u ${mins}m` : `${mins} min`;
        let grandTotalHtml = `<div class="grand-total-box"><h2 style="margin:0 0 5px 0; color:var(--neon-pink); text-align:center;">TOTAAL ALLER TIJDEN</h2><div style="text-align:center; margin-bottom:15px; color:var(--neon-blue); font-size:1.5rem; font-weight:bold;">‚è±Ô∏è ${timeString}</div>`;
        exercises.forEach(ex => { grandTotalHtml += `<div class="stats-detail-row"><span>${ex.name}</span><span style="font-size:1.1rem; color:var(--neon-gold);">${grandTotal[ex.id]} ${ex.unit}</span></div>`; });
        grandTotalHtml += `</div>`;
        container.innerHTML = grandTotalHtml + container.innerHTML;
        if(state.history.length === 0) container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-mute);">Nog geen data.</div>';
    }
</script>
</body>
</html>
